<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <title>Credit Spread Analysis Dashboard</title>
    <style>
        :root{
            --bg-1: #04030a; /* quantum background */
            --bg-2: #060417; /* subtle gradient */
            --card-bg: linear-gradient(180deg, rgba(6,6,18,0.90), rgba(8,6,22,0.78));
            --panel-border: rgba(122,92,255,0.28);
            --accent-cyan: #00dcff;
            --accent-purple: #7a5cff;
            --neon: #00dcff;
            --muted: #a9b4cc;
            --glass: rgba(255,255,255,0.02);
            --tooltip-bg: rgba(6,6,18,0.98);
            --tooltip-text: #e6fbff;
            --select-bg: linear-gradient(180deg, rgba(8,8,20,0.95), rgba(12,6,28,0.92));
            --select-border: rgba(122,92,255,0.55);
            --accent-glow: rgba(0,220,255,0.14);
        }

        /* Base reset */
        *{box-sizing:border-box;margin:0;padding:0}

        html,body{height:100%}

        body {
            font-family: 'Inter', 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
            background: radial-gradient(1200px 600px at 10% 10%, rgba(30,40,60,0.5), transparent), linear-gradient(120deg,var(--bg-1), var(--bg-2));
            color: #cfeef7;
            -webkit-font-smoothing:antialiased;
            padding: 18px;
            background-attachment: fixed;
        }

        /* subtle diagonal stripe overlay to match your theme */
        body::after{
            content:'';position:fixed;inset:0;pointer-events:none;
            background-image: linear-gradient(135deg, rgba(255,255,255,0.015) 10px, transparent 10px);
            opacity:0.14;
            mix-blend-mode:overlay;
        }

        .container{max-width:1200px;margin:0 auto;padding:8px}

        h1{font-family: 'Orbitron', sans-serif;color:var(--accent-cyan);font-size:30px;margin:12px 0 18px;letter-spacing:0.18em;text-transform:uppercase;text-shadow:0 2px 18px var(--accent-glow)}

        .file-selector{
            background: var(--select-bg);
            border:1px solid var(--select-border);
            padding:14px;border-radius:12px;margin-bottom:18px;box-shadow:0 10px 40px rgba(2,6,18,0.6) inset, 0 6px 30px rgba(122,92,255,0.04);
            backdrop-filter: blur(6px);
        }

        .file-selector h2{color:var(--muted);margin-bottom:10px;font-size:14px}

        select{
            width:100%;padding:10px 14px;border-radius:10px;background:var(--select-bg);border:1px solid var(--select-border);color:var(--neon);font-weight:600;appearance:none;-webkit-appearance:none;-moz-appearance:none;position:relative;padding-right:44px;background-repeat:no-repeat;background-position:right 12px center;background-size:20px 20px;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2300dcff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'></polyline></svg>");
        }
        select::-ms-expand{display:none}

        .trades-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:18px}

        .trade-card{
            background: var(--card-bg);
            border-radius:16px;padding:0;overflow:visible;position:relative;border:1px solid rgba(255,255,255,0.03);
            box-shadow: 0 18px 50px rgba(2,8,18,0.6), 0 0 26px rgba(0,220,255,0.06) inset;transition:transform 220ms ease,box-shadow 220ms ease;
        }
        .trade-card:hover{ transform: translateY(-6px); box-shadow: 0 26px 70px rgba(2,8,18,0.7), 0 0 60px rgba(122,92,255,0.08); }

        /* neon border glow */
        .trade-card:before{
            content:'';position:absolute;inset:0;border-radius:16px;padding:1px;
            background:linear-gradient(90deg,var(--accent-cyan),var(--accent-purple));
            -webkit-mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000);
            mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000);
            pointer-events:none;opacity:0.12
        }

        .trade-header{padding:18px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:6px}
        .trade-type{font-size:16px;color:var(--accent-cyan);font-weight:700}
        .trade-strikes{font-size:13px;color:var(--muted)}

        .trade-body{padding:18px}

        .metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}

        .metric{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}

        .metric-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px;margin-bottom:6px}
        .metric-label{position:relative}

        /* Inline tooltip shown when hovering the metric label text */
        .tooltip-inline{
            visibility:hidden;opacity:0;transition:opacity .14s ease,transform .14s ease;pointer-events:none;
            position:absolute;left:100%;top:50%;transform:translateY(-50%);margin-left:10px;z-index:1600;
            background:var(--tooltip-bg);color:var(--tooltip-text);padding:10px 12px;border-radius:8px;font-size:12px;line-height:1.3;min-width:160px;max-width:28ch;box-shadow:0 18px 36px rgba(2,6,18,0.6);border:1px solid rgba(122,92,255,0.10)
        }
        .metric-label:hover .tooltip-inline{visibility:visible;opacity:1;transform:translateY(-50%) translateX(6px);pointer-events:auto}

        /* Detail labels tooltip positioning */
        .detail-label{position:relative}
        .detail-label .tooltip-inline{left:100%;top:0;transform:none;margin-left:10px;width:220px}
        .detail-label:hover .tooltip-inline{visibility:visible;opacity:1}
        .metric-value{font-size:18px;font-weight:800;color:var(--neon)}
        .metric-value.positive{color: #7ef7b8}
        .metric-value.negative{color:#ff7ea6}
        .metric-value.neutral{color:#ffd77a}

        .trade-details{margin-top:16px;padding-top:14px;border-top:1px dashed rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px}
        .detail-row{display:flex;justify-content:space-between;align-items:center}
        .detail-label{color:var(--muted);font-size:13px}
        .detail-value{font-weight:700;color:#d6f9ff}

        .loading{padding:40px;text-align:center;color:var(--muted)}

        /* Tooltip / icon styling */
        .tooltip{position:relative;display:inline-block;cursor:help;margin-left:8px;color:#0b2f38;font-size:12px;width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#e8ffff, #bff7ff);border:1px solid rgba(255,255,255,0.06);text-align:center;line-height:16px;font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,0.5)}
        .tooltip:hover{background:linear-gradient(180deg,var(--accent-cyan),var(--accent-purple));color:#021;} 

        .tooltip .tooltip-text{visibility:hidden;width:280px;max-width:90vw;background:var(--tooltip-bg);color:var(--tooltip-text);border-radius:10px;padding:12px 14px;position:absolute;z-index:1400;bottom:120%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .16s ease,transform .16s ease;font-size:13px;line-height:1.45;box-shadow:0 18px 40px rgba(2,6,18,0.6);border:1px solid rgba(122,92,255,0.12)}
        .tooltip .tooltip-text::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border-width:8px;border-style:solid;border-color:var(--tooltip-bg) transparent transparent transparent}
        .tooltip:hover .tooltip-text{visibility:visible;opacity:1;transform:translateX(-50%) translateY(-6px)}

        /* Left column metrics show tooltip to the right to avoid clipping */
        .metric-grid .metric:nth-child(odd) .tooltip .tooltip-text{left:100%;transform:none;bottom:50%;top:40%;margin-left:12px}
        .metric-grid .metric:nth-child(odd) .tooltip .tooltip-text::after{left:-7px;top:14px;transform:none;border-color:transparent rgba(2,10,20,0.94) transparent transparent}

        /* Right column metrics show tooltip to the left */
        .metric-grid .metric:nth-child(even) .tooltip .tooltip-text{left:auto;right:100%;transform:none;bottom:50%;top:40%;margin-right:12px}
        .metric-grid .metric:nth-child(even) .tooltip .tooltip-text::after{right:-7px;top:14px;transform:none;border-color:transparent transparent transparent rgba(2,10,20,0.94)}

        /* Detail row tooltips appear to the right */
        .detail-row .tooltip .tooltip-text{left:100%;top:0;transform:none;margin-left:10px;width:220px}
        .detail-row .tooltip .tooltip-text::after{left:-7px;top:10px;border-color:transparent rgba(2,10,20,0.94) transparent transparent}

        /* Quantum-themed button styles */
        .btn{
            background: linear-gradient(90deg, rgba(122,92,255,0.12), rgba(0,220,255,0.06));
            border: 1px solid rgba(122,92,255,0.24);
            color: var(--neon);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0,220,255,0.06);
            transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
            font-weight:600;
        }
        #genBtn{
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-cyan));
            color: #060417;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 8px 28px rgba(0,220,255,0.10), inset 0 -2px 10px rgba(0,0,0,0.28);
        }
        #genBtn:hover{ transform: translateY(-2px); box-shadow: 0 14px 40px rgba(0,220,255,0.16); filter:brightness(1.04); }
        #genBtn:active{ transform: translateY(0); }
        .btn:focus{ outline:none; box-shadow: 0 0 0 4px rgba(0,220,255,0.08); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Credit Spread Analysis Dashboard</h1>

        <div class="file-selector">
            <h2>Select Analysis Report</h2>
            <div style="display:flex;gap:10px;align-items:center">
                <select id="fileSelect" style="flex:1">
                    <option value="">Loading reports...</option>
                </select>
                <button id="genBtn" class="btn" style="flex:0 0 auto;padding:8px 12px;">Generate New Report</button>
            </div>
        </div>

        <!-- Overlay for generation progress -->
        <div id="genOverlay" style="display:none;position:fixed;inset:0;background:rgba(2,6,18,0.72);backdrop-filter:blur(4px);z-index:2000;align-items:center;justify-content:center;">
            <div style="text-align:center;color:var(--tooltip-text);">
                <div class="spinner" style="width:88px;height:88px;border-radius:50%;margin:0 auto 18px;border:8px solid rgba(255,255,255,0.06);border-top-color:var(--accent-cyan);animation:spin 900ms linear infinite;"></div>
                <div id="genStatus" style="font-size:16px;color:var(--tooltip-text);opacity:0.95">Preparing...</div>
                <div style="margin-top:8px;font-size:13px;color:var(--muted)">This will create a mocked report file for testing.</div>
            </div>
        </div>

        <style>@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>

        <div id="content">
            <div class="loading">Select an analysis report to view trade details</div>
        </div>
    </div>

    <script>
        const fileSelect = document.getElementById('fileSelect');
        const content = document.getElementById('content');

        // Load available analysis files
        async function loadFiles() {
            try {
                const response = await fetch('/api/reports');
                const files = await response.json();

                fileSelect.innerHTML = '<option value="">Select a report...</option>';
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    option.textContent = formatReportName(file);
                    fileSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading files:', error);
                fileSelect.innerHTML = '<option value="">Error loading reports</option>';
            }
        }

        // Format report filename for display
        function formatReportName(filename) {
            // Remove 'analysis_' prefix and '.json' suffix
            const dateTimeStr = filename.replace('analysis_', '').replace('.json', '');

            // Split into date and time parts
            const [dateStr, timeStr] = dateTimeStr.split('_');

            if (!dateStr || !timeStr || dateStr.length !== 8 || timeStr.length !== 6) {
                return dateTimeStr; // fallback to original if parsing fails
            }

            // Parse date components
            const year = dateStr.substring(0, 4);
            const month = parseInt(dateStr.substring(4, 6)) - 1; // JS months are 0-based
            const day = parseInt(dateStr.substring(6, 8));

            // Parse time components
            const hour = timeStr.substring(0, 2);
            const minute = timeStr.substring(2, 4);
            const second = timeStr.substring(4, 6);

            // Create date object to get month name
            const date = new Date(year, month, day);
            const monthName = date.toLocaleString('en-US', { month: 'long' });

            // Format day with ordinal suffix
            const dayWithSuffix = getDayWithSuffix(day);

            // Format time
            const timeFormatted = `${hour}:${minute}:${second}`;

            return `${monthName} ${dayWithSuffix} at ${timeFormatted}`;
        }

        // Get day with ordinal suffix (1st, 2nd, 3rd, etc.)
        function getDayWithSuffix(day) {
            if (day > 3 && day < 21) return day + 'th';
            switch (day % 10) {
                case 1: return day + 'st';
                case 2: return day + 'nd';
                case 3: return day + 'rd';
                default: return day + 'th';
            }
        }

        // Load and display analysis data
        async function loadAnalysis(filename) {
            if (!filename) {
                content.innerHTML = '<div class="loading">Select an analysis report to view trade details</div>';
                return;
            }

            try {
                content.innerHTML = '<div class="loading">Loading analysis...</div>';

                const response = await fetch(`/api/reports/${filename}`);
                const trades = await response.json();

                displayTrades(trades);
            } catch (error) {
                console.error('Error loading analysis:', error);
                content.innerHTML = '<div class="error">Error loading analysis data</div>';
            }
        }

        // Create tooltip HTML for a metric
        function createTooltip(metricKey) {
            const tooltips = {
                max_profit: "Maximum profit per share if the spread expires worthless. This is the net credit received.",
                max_loss: "Maximum loss per share if the spread moves against you. Equals spread width minus net credit.",
                probability: "Probability of profit (POP) - the likelihood that the trade will be profitable at expiration.",
                return_on_risk: "Maximum profit divided by maximum loss. Higher values indicate better risk-reward ratios.",
                expected_value: "Expected value per share based on probability-weighted outcomes. Positive EV suggests long-term profitability.",
                kelly_fraction: "Optimal position size as a fraction of capital using Kelly Criterion. Values >0 are recommended.",
                break_even: "The underlying price at expiration where the trade breaks even (neither profit nor loss).",
                dte: "Days to expiration - time remaining until the options expire.",
                expected_move: "1-standard deviation expected price move of the underlying based on implied volatility.",
                iv_rv_ratio: "Ratio of implied volatility to realized volatility. >1 suggests options are expensive.",
                trade_quality_score: "Composite score (0-100%) combining probability of profit, return on risk, and IV rank."
            };

            const text = tooltips[metricKey] || "No description available.";
            // Inline tooltip span â€” it should be placed inside the label element so hovering the text shows it
            return `<span class="tooltip-inline">${text}</span>`;
        }

        // Display trades in a nice grid
        function displayTrades(trades) {
            const html = `
                <div class="trades-grid">
                    ${trades.map(trade => `
                        <div class="trade-card">
                            <div class="trade-header">
                                <div class="trade-type">${formatTradeType(trade.spread_type)}</div>
                                <div class="trade-strikes">
                                    ${trade.short_strike} / ${trade.long_strike} (${trade.underlying_price})
                                </div>
                            </div>
                            <div class="trade-body">
                                <div class="metric-grid">
                                    <div class="metric">
                                        <div class="metric-label-container">
                                            <span class="metric-label">Max Profit${createTooltip('max_profit')}</span>
                                        </div>
                                        <div class="metric-value positive">$${trade.max_profit_per_share.toFixed(2)}</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label-container">
                                            <span class="metric-label">Max Loss${createTooltip('max_loss')}</span>
                                        </div>
                                        <div class="metric-value negative">$${trade.max_loss_per_share.toFixed(2)}</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label-container">
                                            <span class="metric-label">Probability${createTooltip('probability')}</span>
                                        </div>
                                        <div class="metric-value neutral">${(trade.p_win_used * 100).toFixed(1)}%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label-container">
                                            <span class="metric-label">Return on Risk${createTooltip('return_on_risk')}</span>
                                        </div>
                                        <div class="metric-value ${trade.return_on_risk > 0.2 ? 'positive' : 'neutral'}">${(trade.return_on_risk * 100).toFixed(1)}%</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label-container">
                                            <span class="metric-label">Expected Value${createTooltip('expected_value')}</span>
                                        </div>
                                        <div class="metric-value ${trade.ev_per_share > 0 ? 'positive' : 'negative'}">$${trade.ev_per_share.toFixed(2)}</div>
                                    </div>
                                    <div class="metric">
                                        <div class="metric-label-container">
                                            <span class="metric-label">Kelly Fraction${createTooltip('kelly_fraction')}</span>
                                        </div>
                                        <div class="metric-value ${trade.kelly_fraction > 0 ? 'positive' : 'negative'}">${(trade.kelly_fraction * 100).toFixed(1)}%</div>
                                    </div>
                                </div>

                                <div class="trade-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Break Even ${createTooltip('break_even')}</span>
                                        <span class="detail-value">${trade.break_even.toFixed(2)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Days to Expiration ${createTooltip('dte')}</span>
                                        <span class="detail-value">${trade.dte}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Expected Move ${createTooltip('expected_move')}</span>
                                        <span class="detail-value">${trade.expected_move ? trade.expected_move.toFixed(2) : 'N/A'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">IV/RV Ratio ${createTooltip('iv_rv_ratio')}</span>
                                        <span class="detail-value">${trade.iv_rv_ratio ? trade.iv_rv_ratio.toFixed(2) : 'N/A'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Trade Quality Score ${createTooltip('trade_quality_score')}</span>
                                        <span class="detail-value">${(trade.trade_quality_score * 100).toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            content.innerHTML = html;
            // Attach handlers to position tooltips so they stay within their trade-card
            attachTooltipHandlers();
        }

        // Ensure inline tooltips are positioned inside their .trade-card and never overflow it.
        function attachTooltipHandlers(){
            const labels = document.querySelectorAll('.metric-label, .detail-label');
            labels.forEach(label => {
                const tip = label.querySelector('.tooltip-inline');
                if(!tip) return;

                function show(){
                    // measure tooltip size by rendering it offscreen first
                    tip.style.display = 'block';
                    tip.style.visibility = 'hidden';
                    tip.style.position = 'fixed';
                    tip.style.left = '-9999px';
                    tip.style.top = '-9999px';

                    const tipRect = tip.getBoundingClientRect();
                    const labelRect = label.getBoundingClientRect();
                    const card = label.closest('.trade-card') || document.body;
                    const cardRect = card.getBoundingClientRect();

                    const gap = 8;
                    // compute preferred viewport coords
                    let desiredLeft = labelRect.right + gap;
                    if(desiredLeft + tipRect.width + gap > cardRect.right){
                        // flip to left of label
                        desiredLeft = labelRect.left - tipRect.width - gap;
                    }

                    // clamp horizontally inside card
                    if(desiredLeft < cardRect.left + gap) desiredLeft = cardRect.left + gap;
                    if(desiredLeft + tipRect.width > cardRect.right - gap) desiredLeft = cardRect.right - tipRect.width - gap;

                    // vertical center relative to label, clamped to card
                    let desiredTop = labelRect.top + (labelRect.height - tipRect.height)/2;
                    if(desiredTop < cardRect.top + gap) desiredTop = cardRect.top + gap;
                    if(desiredTop + tipRect.height + gap > cardRect.bottom) desiredTop = cardRect.bottom - tipRect.height - gap;

                    // move tip into the card so absolute coords are local to the card
                    try{ card.appendChild(tip); } catch(e){}
                    tip.style.position = 'absolute';
                    tip.style.left = `${Math.round(desiredLeft - cardRect.left)}px`;
                    tip.style.top = `${Math.round(desiredTop - cardRect.top)}px`;
                    tip.style.visibility = 'visible';
                    tip.style.opacity = '1';
                    tip.style.pointerEvents = 'auto';
                }

                function hide(){
                    tip.style.visibility = 'hidden';
                    tip.style.opacity = '0';
                    tip.style.pointerEvents = 'none';
                    tip.style.display = '';
                }

                // Remove existing listeners to avoid duplicates
                label.removeEventListener('mouseenter', label._tipEnter);
                label.removeEventListener('mouseleave', label._tipLeave);
                label._tipEnter = show; label._tipLeave = hide;
                label.addEventListener('mouseenter', show);
                label.addEventListener('mouseleave', hide);
            });
        }

        function formatTradeType(type) {
            return type === 'put_credit' ? 'ðŸ“‰ Put Credit Spread' : 'ðŸ“ˆ Call Credit Spread';
        }

        // Event listeners
        fileSelect.addEventListener('change', (e) => {
            loadAnalysis(e.target.value);
        });

        // Generate new report button (uses SSE to stream progress)
        document.getElementById('genBtn').addEventListener('click', ()=>{
            const overlay = document.getElementById('genOverlay');
            const status = document.getElementById('genStatus');
            overlay.style.display = 'flex';
            status.textContent = 'Starting...';

            const evt = new EventSource('/api/generate');
            evt.addEventListener('progress', (e)=>{
                try{
                    const data = JSON.parse(e.data);
                    status.textContent = data.message || data.step || 'Working...';
                }catch(err){ status.textContent = e.data }
            });
            evt.addEventListener('done', (e)=>{
                const data = JSON.parse(e.data);
                const fn = data.filename;
                status.textContent = 'Completed â€” ' + fn;
                // close after a short delay so users see completion
                setTimeout(()=>{
                    overlay.style.display = 'none';
                    evt.close();
                    // refresh file list and auto-select the new report
                    loadFiles().then(()=>{
                        const opt = Array.from(fileSelect.options).find(o=>o.value===fn);
                        if(opt){ fileSelect.value = fn; loadAnalysis(fn); }
                    });
                }, 900);
            });
            evt.addEventListener('error', (e)=>{
                // EventSource fires 'error' when the connection closes normally in some browsers.
                // Only show an error message if the event includes data with a message.
                try{
                    if(e && e.data){
                        const d = JSON.parse(e.data);
                        if(d && d.message){
                            status.textContent = 'Error: ' + d.message;
                        }
                    }
                }catch(err){
                    // ignore parse errors / non-informative error events
                }
                // If connection truly closed, ensure overlay is removed after a short delay.
                if(evt.readyState === EventSource.CLOSED){
                    setTimeout(()=>{ overlay.style.display='none'; evt.close(); }, 900);
                }
            });
        });

        // Load files on page load
        loadFiles();
    </script>
</body>
</html>